import{e as j,b3 as x,b4 as T,b5 as Z,b6 as G,b7 as M,b8 as y,aZ as F,b9 as X,ba as Y,bb as v}from"./index-Br3x8Ng2.js";import{isFeatureIdentifierArrayWithGlobalId as D,isFeatureIdentifierArrayWithObjectId as J}from"./editingSupport-B-6z0gQl.js";async function P(a,e,s){const{geometry:r}=e,t={...e.attributes};if(s!=null&&r?.type==="mesh"){const{transformFieldRoles:n}=s,{origin:c,spatialReference:o,vertexSpace:p}=r,l=r.transform??new x,i=p.type==="local",u=a.spatialReference,h=u.isGeographic,w=T(u,o),$=Z(o,u)&&G(o,u);if(!(i&&h&&$||!i&&!h&&w))return null;const m=M(c,o,u);if(m==null)return null;if(t[n.originX]=m.x,t[n.originY]=m.y,t[n.originZ]=m.z??0,l!=null){const{translation:g,scale:I,rotation:f}=l,R=i?1:y(o)/y(u);t[n.translationX]=g[0]*R,t[n.translationY]=g[2]*R,t[n.translationZ]=-g[1]*R,t[n.scaleX]=I[0],t[n.scaleY]=I[2],t[n.scaleZ]=I[1],t[n.rotationX]=f[0],t[n.rotationY]=f[2],t[n.rotationZ]=-f[1],t[n.rotationDeg]=f[3]}return{attributes:t}}return r==null?{attributes:t}:r.type==="mesh"||r.type==="extent"?null:{geometry:r.toJSON(),attributes:t}}async function S(a,e){const s=await Promise.all((e.addAttachments??[]).map(n=>A(a,n))),r=await Promise.all((e.updateAttachments??[]).map(n=>A(a,n))),t=e.deleteAttachments??[];return s.length||r.length||t.length?{adds:s,updates:r,deletes:[...t]}:null}async function A(a,e){const{feature:s,attachment:r}=e,{globalId:t,name:n,contentType:c,data:o,uploadId:p}=r,l={globalId:t};if(s&&("attributes"in s?l.parentGlobalId=s.attributes?.[a.globalIdField]:s.globalId&&(l.parentGlobalId=s.globalId)),p)l.uploadId=p;else if(o){const i=await X(o);i&&(l.contentType=i.mediaType,l.data=i.data),o instanceof File&&(l.name=o.name)}return n&&(l.name=n),c&&(l.contentType=c),l}function U(a,e,s){if(!e||e.length===0)return[];if(s&&D(e))return e.map(t=>t.globalId);if(J(e))return e.map(t=>t.objectId);const r=s?a.globalIdField:a.objectIdField;return r?e.map(t=>t.getAttribute(r)):[]}function W(a){const e=a?.assetMaps;if(e){for(const t of e.addResults)t.success||F.getLogger("esri.layers.graphics.sources.support.sourceUtils").error(`Failed to map asset to feature with globalId ${t.globalId}.`);for(const t of e.updateResults)t.success||F.getLogger("esri.layers.graphics.sources.support.sourceUtils").error(`Failed to map asset to feature with globalId ${t.globalId}.`)}const s=a?.attachments,r={addFeatureResults:a?.addResults?.map(d)??[],updateFeatureResults:a?.updateResults?.map(d)??[],deleteFeatureResults:a?.deleteResults?.map(d)??[],addAttachmentResults:s?.addResults?s.addResults.map(d):[],updateAttachmentResults:s?.updateResults?s.updateResults.map(d):[],deleteAttachmentResults:s?.deleteResults?s.deleteResults.map(d):[]};return a?.editMoment&&(r.editMoment=a.editMoment),r}function d(a){const e=a.success===!0?null:a.error||{code:void 0,description:"Feature edit failed"};return{objectId:a.objectId,globalId:a.globalId,error:e?new j("feature-layer-source:edit-failure",e.description,{code:e.code}):null}}function b(a,e){return new Y({attributes:a.attributes,geometry:v({...a.geometry,spatialReference:e})})}function z(a,e){return{adds:a?.adds?.map(s=>b(s,e))||[],updates:a?.updates?.map(s=>({original:b(s[0],e),current:b(s[1],e)}))||[],deletes:a?.deletes?.map(s=>b(s,e))||[],spatialReference:e}}function C(a){const e=a.details.raw,s=+e.code,r=+e.extendedCode;return s===500&&(r===-2147217144||r===-2147467261)}export{z as I,d as R,U as b,S as f,C as j,P as m,W as y};
